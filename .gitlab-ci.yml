stages:
  - build-dev
  - test
  - lint
  - build
  - deploy

variables:
  PROD_BRANCH: "main"
  DEV_BRANCH: "develop"

.kaniko-build:
  variables:
    # Additional options for Kaniko executor.
    # For more details see https://github.com/GoogleContainerTools/kaniko/blob/master/README.md#additional-flags
    KANIKO_ARGS: "--label ci.branch=${CI_COMMIT_BRANCH} --label ci.commit=${CI_COMMIT_SHA} --cache-copy-layers --cache=true"
    KANIKO_BUILD_CONTEXT: $CI_PROJECT_DIR
  stage: build
  image:
    # For latest releases see https://github.com/GoogleContainerTools/kaniko/releases
    # Only debug/*-debug versions of the Kaniko image are known to work within Gitlab CI
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - |
      if [ -z ${IMAGE_TAG+x} ]; then
        if [ "$CI_COMMIT_REF_NAME" = $PROD_BRANCH ]; then
          if [ -n "$CI_COMMIT_TAG" ];then
            NOSLASH=$(echo "$CI_COMMIT_TAG" | tr -s / - )
            SANITIZED="${NOSLASH//[^a-zA-Z0-9.-]/}"
            TAG_FOR_DEFAULT_BRANCHE="$SANITIZED"
            KANIKO_ARGS="${KANIKO_ARGS} --label ci.tag=${TAG_FOR_DEFAULT_BRANCHE} --destination ${TAG_FOR_DEFAULT_BRANCHE}"
            VERSION="latest"
          fi
        elif [ -n "$CI_COMMIT_TAG" ];then
          NOSLASH=$(echo "$CI_COMMIT_TAG" | tr -s / - )
          SANITIZED="${NOSLASH//[^a-zA-Z0-9.-]/}"
          VERSION="$SANITIZED"
          KANIKO_ARGS="${KANIKO_ARGS} --label ci.tag=${VERSION}"
        else \
          NOSLASH=$(echo "$CI_COMMIT_REF_NAME" | tr -s / - )
          SANITIZED="${NOSLASH//[^a-zA-Z0-9-]/}"
          VERSION="branch-$SANITIZED-${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_ID}"
        fi
        if [ -n "$BUILD_TYPE" ]; then
          if [ "$BUILD_TYPE" = "develop" ]; then
            VERSION="${VERSION}-dev"
          fi
        fi
          
        export IMAGE_TAG=$CI_REGISTRY_IMAGE:$VERSION
      fi
    - echo $IMAGE_TAG
    - mkdir -p /kaniko/.docker
    # Write credentials to access Gitlab Container Registry within the runner/ci
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n
      ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} |
      base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - cat /kaniko/.docker/config.json
    # Build and push the container. To disable push add --no-push
    # Both Dockerfile and Containerfile are supported. For retrocompatibility, if both files are present, Dockerfile will be used.
    - |
      if [ -z "$DOCKERFILE_PATH" ]; then
        if [ -f "$KANIKO_BUILD_CONTEXT/Dockerfile" ]; then
          DOCKERFILE_PATH="$KANIKO_BUILD_CONTEXT/Dockerfile"
        elif [ -n "$CONTAINERFILE_PATH" ]; then
          DOCKERFILE_PATH="$CONTAINERFILE_PATH"
        elif [ -f "$KANIKO_BUILD_CONTEXT/Containerfile" ]; then
          DOCKERFILE_PATH="$KANIKO_BUILD_CONTEXT/Containerfile"
        else \
          echo "No suitable configuration for the build context have been found. Please check your configuration."
          exit 1
        fi
      fi
    - echo $DOCKERFILE_PATH
    - /kaniko/executor --context $KANIKO_BUILD_CONTEXT --dockerfile $DOCKERFILE_PATH --destination $IMAGE_TAG $KANIKO_ARGS
  # Run this job in a branch/tag where a Containerfile/Dockerfile exists
  rules:
    - exists:
        - Containerfile
        - Dockerfile
    # custom Containerfile/Dockerfile path
    # If both variables are set, DOCKERFILE_PATH will be used
    - if: $DOCKERFILE_PATH
    - if: $CONTAINERFILE_PATH
    # custom build context without an explicit Dockerfile path
    - if: $KANIKO_BUILD_CONTEXT != $CI_PROJECT_DIR

kaniko-build-dev:
  stage: build-dev
  extends: .kaniko-build
  variables:
    DOCKERFILE_PATH: "docker/Dockerfile.Dev"
    BUILD_TYPE: "develop"
  tags:
    - local-k8s

unit-test-job: # This job runs in the test stage.
  stage: test # It only starts when the job in the build stage completes successfully.
  script:
    - echo "Running unit tests... This will take about 60 seconds."
    - sleep 60
    - echo "Code coverage is 90%"
  tags:
    - local-k8s

lint-test-job: # This job also runs in the test stage.
  stage: test # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Linting code... This will take about 10 seconds."
    # - yarn run lint
    - sleep 60
    - echo "No lint issues found."
  tags:
    - local-k8s

kaniko-build-prod:
  stage: build
  extends: .kaniko-build
  variables:
    DOCKERFILE_PATH: "docker/Dockerfile.Prod"
  tags:
    - local-k8s

deploy-job: # This job runs in the deploy stage.
  stage: deploy # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
  tags:
    - local-k8s
